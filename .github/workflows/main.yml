name: Terraform Security Analysis

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  trivy-analysis:
    name: Terraform Security Analysis
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis

      - name: Install tfsec and Trivy
        run: |
          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --version
          echo "hi:"
          ls -l
          echo "---"
      
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version
          echo "Trivy installed."
          echo "Starting tfsec analysis..."
          # Run tfsec analysis on the current directory (root directory)
          tfsec ./ --format sarif --out tfsec_report.sarif
          echo "tfsec analysis completed."
          # List the output file to confirm it was written
          ls -l tfsec_report.sarif
          echo "SARIF report file should be above."
      
      - name: Run tfsec analysis and generate SARIF report
        run: |
          tfsec ./ --format sarif --out tfsec_report.sarif
          echo "tfsec analysis completed."
      
      - name: Upload SARIF Report to GitHub
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: tfsec_report.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Add Aqua Security repository and install Trivy
      - name: Install Trivy
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          tfsec --version
          echo "hi:"
          ls -l
          echo "---";
          
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.18.3
          #trivy --version
          echo "000000"
            tfsec ./ --format sarif --out tfsec_report.sarif
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          echo "000000"
          echo "Running tfsec analysis..."
          # trivy fs --security-checks vuln ../.. --format sarif --output ../trivy_report.sarif
          # echo "+++++"
          # trivy fs --security-checks vuln ./ --format sarif --output trivy_report.sarif
          # echo "======="
          # tfsec ./ --format sarif --out tfsec_report.sarif
          # echo "tfsec analysis completed. Checking for SARIF report file..."
          # ls -l tfsec_report.sarif
          # echo "SARIF report file should be above."
          # tfsec ./ --format sarif --out tfsec_report.sarif
          #  echo "===";
       
      # Run Trivy analysis on Terraform files and generate SARIF report
      - name: Run Trivy and generate SARIF report
        run: |
          trivy fs --security-checks vuln ./ --format sarif --output trivy_report.sarif

      # Upload SARIF Report to GitHub
      - name: Upload SARIF Report to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy_report.sarif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
